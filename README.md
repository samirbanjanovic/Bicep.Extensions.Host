# Bicep.Extension.Host

The `Bicep.Extension.Host` project introduces a modern, .NET-native approach for building Bicep extensions. The handler framework has been redesigned to support **strongly typed handlers** and **type-based routing**, making extension development more robust and maintainable. Type specification is now generated directly through the service, enabling a seamless extension publishing experience.

## What's New

- **Strongly Typed Handlers**: Handlers are now registered as strongly typed classes. Routing of requests is based on the type received, ensuring type safety and reducing boilerplate.
- **Type-Based Routing**: The framework automatically routes incoming resource requests to the correct handler based on the resource type.
- **Service-Driven TypeSpec Generation**: Type metadata (TypeSpec) is generated by the service at runtime, simplifying the process of publishing and updating extensions.
- **.NET Standard Patterns**: Extensions use standard `WebApplicationBuilder` and DI container patterns.
- **No Wrappers**: You interact directly with the DI system and ASP.NET Core primitives.
- **Sample Implementation**: See [`Bicep.Extension.Sample`](src/Bicep.Extension.Sample/Program.cs) for a complete example.

## gRPC Server for Bicep Communication

This host starts a **gRPC server** to enable communication between Bicep and your extension. The server is configured using command-line arguments, which are passed through the `AddBicepExtensionHost(args)` function.

### Required Command-Line Arguments

All extension binaries are expected to accept the following CLI arguments:

- `--socket <socket_name>`: The path to the domain socket to connect on.
- `--pipe <pipe_name>`: The named pipe to connect on.
- `--http <port>` : The port to use for service. Default is 5000
- `--wait-for-debugger`: Signals that you want to debug the extension, and that execution should pause until you are ready.

Once started (either via domain socket or named pipe), the extension:

- Exposes a gRPC endpoint over the relevant channel, adhering to the extension gRPC contract.
- Responds to `SIGTERM` to request a graceful shutdown.

## Handler Types

The handler framework now supports **strongly typed handlers** and **type-based routing**. You can implement one of the following handler types:

- **`TypedResourceHandler<T>`**: A strongly typed handler for a specific resource type. This enables type-safe operations and reduces boilerplate by allowing you to work directly with your resource's .NET type.
- **`GenericTypedResourceHandler`**: A flexible base handler that can process any resource type using the generic `object` type. This is useful for scenarios where you need to handle multiple resource types in a single handler.

You can also use the following interfaces for advanced scenarios:

- **`ITypedResourceHandler<T>`**: Interface for implementing a strongly typed handler for a specific resource type.
- **`ITypedResourceHandler`**: Interface for implementing a generic handler that works with untyped resources.

> **Note:**  
> `TypedResourceHandler<T>` is a specialized implementation of `GenericTypedResourceHandler`.

> **Important:**  
> By design, you can only define one generic handler (`GenericTypedResourceHandler`) per extension, but you can have multiple strongly typed handlers (`TypedResourceHandler<T>`) for different resource types.

## Example Usage

Below is a minimal example from [`Bicep.Extension.Sample/Program.cs`](src/Bicep.Extension.Sample/Program.cs):

```csharp
public class Program
{
    static async Task Main(string[] args)
    {
        var builder = WebApplication
                            .CreateBuilder()
                            .AddBicepExtensionHost(args);

        builder.Services
                .AddBicepServices()
                .AddGenericBicepResourceHandler<OmniHandler>()
                .AddTypedBicepResourceHandler<StronglyTypedHandler>()
                .AddSingleton<IBackendService, LocalOutputService>();

        var app = builder.Build();
        app.UseBicepDispatcher();

        await app.RunAsync();
    }
}
```

- Register your handlers and services using the DI container.
- Use `.AddTypedBicepResourceHandler<T>()` for your strongly typed handler, or `.AddGenericBicepResourceHandler<T>()` for a generic handler.
- TypeSpec is generated automatically by the service for your registered types.
- Build and run your app as you would with any ASP.NET Core gRPC application.

For more details, see the sample implementation in [src/Bicep.Extension.Sample/Program.cs](src/Bicep.Extension.Sample/Program.cs).